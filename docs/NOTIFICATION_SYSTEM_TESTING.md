# é€šçŸ¥ç³»ç»Ÿæµ‹è¯•æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„é€šçŸ¥ç³»ç»Ÿæµ‹è¯•æ­¥éª¤ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¿ç§»ã€åŠŸèƒ½æµ‹è¯•å’ŒéªŒè¯æ–¹æ³•ã€‚

## ğŸ”§ å‰ç½®å‡†å¤‡

### 1. è¿è¡Œæ•°æ®åº“è¿ç§»

é€šçŸ¥ç³»ç»Ÿéœ€è¦å…ˆåˆ›å»ºæ•°æ®åº“è¡¨ã€‚æœ‰ä¸¤ç§æ–¹å¼è¿è¡Œè¿ç§»ï¼š

#### æ–¹å¼ Aï¼šé€šè¿‡ Neon æ§åˆ¶å°ï¼ˆæ¨èï¼‰

1. ç™»å½• [Neon Console](https://console.neon.tech/)
2. é€‰æ‹©ä½ çš„é¡¹ç›®å’Œæ•°æ®åº“
3. æ‰“å¼€ SQL Editor
4. å¤åˆ¶ `migrations/007_create_notifications.sql` çš„å†…å®¹
5. ç²˜è´´å¹¶æ‰§è¡Œ

#### æ–¹å¼ Bï¼šé€šè¿‡ API è·¯ç”±

1. ç¡®ä¿åº”ç”¨å·²éƒ¨ç½²åˆ° Vercel
2. è®¿é—®ï¼š`https://your-app.vercel.app/api/migrate/notifications`
3. æŸ¥çœ‹è¿”å›çš„ JSON ç¡®è®¤è¿ç§»æˆåŠŸ

### 2. éªŒè¯è¡¨åˆ›å»º

åœ¨ Neon SQL Editor ä¸­è¿è¡Œï¼š

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
SELECT * FROM information_schema.tables
WHERE table_name = 'notifications';

-- æŸ¥çœ‹è¡¨ç»“æ„
\d notifications

-- æ£€æŸ¥ç´¢å¼•
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'notifications';
```

## ğŸ§ª åŠŸèƒ½æµ‹è¯•

### æµ‹è¯• 1ï¼šç»´æŠ¤æé†’é€šçŸ¥

**ç›®çš„**ï¼šæµ‹è¯•è¿ç»­ä½¿ç”¨è¶…è¿‡ 30 å¤©çš„è¢«å­ä¼šæ”¶åˆ°ç»´æŠ¤æé†’

**æ­¥éª¤**ï¼š

1. åˆ›å»ºä¸€ä¸ªæµ‹è¯•è¢«å­
2. å°†è¢«å­çŠ¶æ€æ”¹ä¸º"ä½¿ç”¨ä¸­"
3. åœ¨æ•°æ®åº“ä¸­æ‰‹åŠ¨ä¿®æ”¹ä½¿ç”¨è®°å½•çš„å¼€å§‹æ—¶é—´ä¸º 35 å¤©å‰ï¼š

```sql
-- æŸ¥æ‰¾æ´»è·ƒçš„ä½¿ç”¨è®°å½•
SELECT * FROM usage_records WHERE end_date IS NULL;

-- ä¿®æ”¹å¼€å§‹æ—¶é—´ä¸º 35 å¤©å‰
UPDATE usage_records
SET start_date = NOW() - INTERVAL '35 days'
WHERE id = 'your-usage-record-id';
```

4. è§¦å‘é€šçŸ¥æ£€æŸ¥ï¼š
   - åˆ·æ–°åº”ç”¨é¡µé¢ï¼ˆä¼šè‡ªåŠ¨è§¦å‘æ£€æŸ¥ï¼‰
   - æˆ–è€…ç­‰å¾… 1 å°æ—¶ï¼ˆè‡ªåŠ¨æ£€æŸ¥ï¼‰
   - æˆ–è€…åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š

   ```javascript
   // æ‰‹åŠ¨è§¦å‘æ£€æŸ¥
   fetch('/api/trpc/notifications.checkMaintenance', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({}),
   })
     .then(r => r.json())
     .then(console.log);
   ```

5. ç‚¹å‡»å³ä¸Šè§’çš„é€šçŸ¥å›¾æ ‡ï¼ˆé“ƒé“›ï¼‰
6. åº”è¯¥çœ‹åˆ°ä¸€æ¡ç»´æŠ¤æé†’é€šçŸ¥ï¼Œä¼˜å…ˆçº§ä¸º"ä¸­"

**é¢„æœŸç»“æœ**ï¼š

- âœ… é€šçŸ¥é¢æ¿æ˜¾ç¤ºç»´æŠ¤æé†’
- âœ… é€šçŸ¥æ ‡é¢˜ï¼š`ç»´æŠ¤æé†’ï¼š[è¢«å­åç§°]`
- âœ… é€šçŸ¥å†…å®¹ï¼š`å·²è¿ç»­ä½¿ç”¨ 35 å¤©ï¼Œå»ºè®®è¿›è¡Œæ¸…æ´—æˆ–æ™¾æ™’ç»´æŠ¤`
- âœ… ä¼˜å…ˆçº§å¾½ç« æ˜¾ç¤º"ä¸­"ï¼ˆé»„è‰²ï¼‰
- âœ… å›¾æ ‡æ˜¾ç¤ºæ‰³æ‰‹ ğŸ”§

### æµ‹è¯• 2ï¼šæ·˜æ±°å»ºè®®é€šçŸ¥

**ç›®çš„**ï¼šæµ‹è¯• 365 å¤©æœªä½¿ç”¨çš„è¢«å­ä¼šæ”¶åˆ°æ·˜æ±°å»ºè®®

**æ­¥éª¤**ï¼š

1. åˆ›å»ºä¸€ä¸ªæµ‹è¯•è¢«å­
2. åˆ›å»ºä¸€æ¡å†å²ä½¿ç”¨è®°å½•ï¼ˆå·²ç»“æŸï¼‰
3. ä¿®æ”¹ä½¿ç”¨è®°å½•çš„ç»“æŸæ—¶é—´ä¸º 400 å¤©å‰ï¼š

```sql
-- åˆ›å»ºå†å²ä½¿ç”¨è®°å½•
INSERT INTO usage_records (id, quilt_id, start_date, end_date, usage_type, created_at, updated_at)
VALUES (
  gen_random_uuid(),
  'your-quilt-id',
  NOW() - INTERVAL '410 days',
  NOW() - INTERVAL '400 days',
  'REGULAR',
  NOW(),
  NOW()
);
```

4. è§¦å‘é€šçŸ¥æ£€æŸ¥ï¼ˆåŒä¸Šï¼‰
5. æŸ¥çœ‹é€šçŸ¥é¢æ¿

**é¢„æœŸç»“æœ**ï¼š

- âœ… é€šçŸ¥é¢æ¿æ˜¾ç¤ºæ·˜æ±°å»ºè®®
- âœ… é€šçŸ¥æ ‡é¢˜ï¼š`æ·˜æ±°å»ºè®®ï¼š[è¢«å­åç§°]`
- âœ… é€šçŸ¥å†…å®¹ï¼š`å·²ç» 400 å¤©æœªä½¿ç”¨ï¼Œå»ºè®®è€ƒè™‘æ˜¯å¦éœ€è¦ä¿ç•™`
- âœ… ä¼˜å…ˆçº§å¾½ç« æ˜¾ç¤º"ä½"ï¼ˆç°è‰²ï¼‰
- âœ… å›¾æ ‡æ˜¾ç¤ºå½’æ¡£ ğŸ“¦

### æµ‹è¯• 3ï¼šé€šçŸ¥é¢æ¿åŠŸèƒ½

**æ­¥éª¤**ï¼š

1. ç‚¹å‡»å³ä¸Šè§’çš„é€šçŸ¥å›¾æ ‡
2. éªŒè¯é€šçŸ¥é¢æ¿æ‰“å¼€
3. æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š

#### 3.1 æŸ¥çœ‹é€šçŸ¥

- âœ… æœªè¯»é€šçŸ¥æœ‰è“è‰²èƒŒæ™¯
- âœ… æœªè¯»é€šçŸ¥å³ä¾§æœ‰è“è‰²åœ†ç‚¹
- âœ… æ˜¾ç¤ºä¼˜å…ˆçº§å¾½ç« 
- âœ… æ˜¾ç¤ºç›¸å¯¹æ—¶é—´ï¼ˆå¦‚"5åˆ†é’Ÿå‰"ï¼‰

#### 3.2 æ ‡è®°å·²è¯»

- ç‚¹å‡»ä»»æ„é€šçŸ¥
- âœ… è“è‰²èƒŒæ™¯æ¶ˆå¤±
- âœ… è“è‰²åœ†ç‚¹æ¶ˆå¤±
- âœ… å¦‚æœæœ‰ actionUrlï¼Œé¡µé¢è·³è½¬åˆ°ç›¸å…³é¡µé¢

#### 3.3 åˆ é™¤é€šçŸ¥

- ç‚¹å‡»é€šçŸ¥å³ä¸‹è§’çš„åƒåœ¾æ¡¶å›¾æ ‡
- âœ… é€šçŸ¥ä»åˆ—è¡¨ä¸­æ¶ˆå¤±

#### 3.4 å…¨éƒ¨æ ‡è®°å·²è¯»

- ç‚¹å‡»é¡¶éƒ¨çš„"å…¨éƒ¨æ ‡è®°å·²è¯»"æŒ‰é’®ï¼ˆåŒå‹¾å›¾æ ‡ï¼‰
- âœ… æ‰€æœ‰é€šçŸ¥å˜ä¸ºå·²è¯»çŠ¶æ€
- âœ… æœªè¯»æ•°é‡å˜ä¸º 0

#### 3.5 æœªè¯»è®¡æ•°

- âœ… é€šçŸ¥å›¾æ ‡ä¸Šæ˜¾ç¤ºæœªè¯»æ•°é‡å¾½ç« 
- âœ… æ•°é‡æ­£ç¡®ï¼ˆæœ€å¤šæ˜¾ç¤º 9+ï¼‰
- âœ… æ²¡æœ‰æœªè¯»æ—¶ä¸æ˜¾ç¤ºå¾½ç« 

### æµ‹è¯• 4ï¼šè‡ªåŠ¨æ£€æŸ¥åŠŸèƒ½

**æ­¥éª¤**ï¼š

1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
2. åˆ‡æ¢åˆ° Console æ ‡ç­¾
3. åˆ·æ–°é¡µé¢
4. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º

**é¢„æœŸç»“æœ**ï¼š

- âœ… çœ‹åˆ° "Running initial notification check..." æ—¥å¿—
- âœ… çœ‹åˆ° "Notification check completed" æ—¥å¿—
- âœ… å¦‚æœåˆ›å»ºäº†æ–°é€šçŸ¥ï¼Œçœ‹åˆ° "Created X new notifications"

### æµ‹è¯• 5ï¼šé€šçŸ¥æŒä¹…åŒ–

**æ­¥éª¤**ï¼š

1. åˆ›å»ºä¸€äº›é€šçŸ¥
2. å…³é—­æµè§ˆå™¨
3. é‡æ–°æ‰“å¼€åº”ç”¨
4. æŸ¥çœ‹é€šçŸ¥é¢æ¿

**é¢„æœŸç»“æœ**ï¼š

- âœ… ä¹‹å‰çš„é€šçŸ¥ä»ç„¶å­˜åœ¨
- âœ… æœªè¯»çŠ¶æ€ä¿æŒä¸å˜
- âœ… é€šçŸ¥æŒ‰æ—¶é—´å€’åºæ’åˆ—

## ğŸ” æ•°æ®åº“éªŒè¯

### æŸ¥çœ‹æ‰€æœ‰é€šçŸ¥

```sql
SELECT
  id,
  type,
  priority,
  title,
  message,
  quilt_id,
  is_read,
  created_at
FROM notifications
ORDER BY created_at DESC
LIMIT 20;
```

### æŸ¥çœ‹æœªè¯»é€šçŸ¥æ•°é‡

```sql
SELECT COUNT(*) as unread_count
FROM notifications
WHERE is_read = false;
```

### æŸ¥çœ‹å„ç±»å‹é€šçŸ¥ç»Ÿè®¡

```sql
SELECT
  type,
  priority,
  COUNT(*) as count,
  SUM(CASE WHEN is_read THEN 0 ELSE 1 END) as unread_count
FROM notifications
GROUP BY type, priority
ORDER BY type, priority;
```

### æ‰‹åŠ¨åˆ›å»ºæµ‹è¯•é€šçŸ¥

```sql
INSERT INTO notifications (
  id, type, priority, title, message,
  quilt_id, action_url, metadata, created_at, updated_at
)
VALUES (
  gen_random_uuid(),
  'maintenance_reminder',
  'high',
  'æµ‹è¯•é€šçŸ¥',
  'è¿™æ˜¯ä¸€æ¡æµ‹è¯•é€šçŸ¥æ¶ˆæ¯',
  NULL,
  '/quilts',
  '{"test": true}',
  NOW(),
  NOW()
);
```

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šé€šçŸ¥ä¸æ˜¾ç¤º

**æ£€æŸ¥æ¸…å•**ï¼š

1. æ•°æ®åº“è¡¨æ˜¯å¦åˆ›å»ºï¼Ÿ
   ```sql
   SELECT * FROM notifications LIMIT 1;
   ```
2. æ˜¯å¦æœ‰é€šçŸ¥æ•°æ®ï¼Ÿ
   ```sql
   SELECT COUNT(*) FROM notifications;
   ```
3. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ï¼Ÿ
4. ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸï¼Ÿï¼ˆæŸ¥çœ‹ Network æ ‡ç­¾ï¼‰

### é—®é¢˜ 2ï¼šé€šçŸ¥æ£€æŸ¥ä¸è¿è¡Œ

**æ£€æŸ¥æ¸…å•**ï¼š

1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ "Running initial notification check" æ—¥å¿—
2. æ£€æŸ¥æ˜¯å¦æœ‰ JavaScript é”™è¯¯
3. ç¡®è®¤ NotificationChecker ç»„ä»¶å·²åŠ è½½
4. æ£€æŸ¥ tRPC è¿æ¥æ˜¯å¦æ­£å¸¸

### é—®é¢˜ 3ï¼šæœªè¯»è®¡æ•°ä¸æ›´æ–°

**è§£å†³æ–¹æ³•**ï¼š

1. åˆ·æ–°é¡µé¢
2. æ£€æŸ¥ `getUnreadCount` API æ˜¯å¦è¿”å›æ­£ç¡®æ•°æ®
3. åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
   ```javascript
   fetch('/api/trpc/notifications.getUnreadCount')
     .then(r => r.json())
     .then(console.log);
   ```

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯•å¤§é‡é€šçŸ¥

åˆ›å»º 100 æ¡æµ‹è¯•é€šçŸ¥ï¼š

```sql
INSERT INTO notifications (id, type, priority, title, message, created_at, updated_at)
SELECT
  gen_random_uuid(),
  (ARRAY['weather_change', 'maintenance_reminder', 'disposal_suggestion'])[floor(random() * 3 + 1)],
  (ARRAY['high', 'medium', 'low'])[floor(random() * 3 + 1)],
  'æµ‹è¯•é€šçŸ¥ ' || generate_series,
  'è¿™æ˜¯æµ‹è¯•é€šçŸ¥æ¶ˆæ¯ ' || generate_series,
  NOW() - (random() * INTERVAL '30 days'),
  NOW()
FROM generate_series(1, 100);
```

**éªŒè¯**ï¼š

- âœ… é€šçŸ¥é¢æ¿æ»šåŠ¨æµç•…
- âœ… åŠ è½½æ—¶é—´ < 2 ç§’
- âœ… åˆ†é¡µæ­£å¸¸å·¥ä½œï¼ˆé»˜è®¤æ˜¾ç¤º 50 æ¡ï¼‰

## ğŸ¯ é›†æˆæµ‹è¯•åœºæ™¯

### åœºæ™¯ 1ï¼šå®Œæ•´çš„è¢«å­ä½¿ç”¨æµç¨‹

1. åˆ›å»ºæ–°è¢«å­
2. å¼€å§‹ä½¿ç”¨ï¼ˆçŠ¶æ€æ”¹ä¸º"ä½¿ç”¨ä¸­"ï¼‰
3. ä¿®æ”¹ä½¿ç”¨è®°å½•ä¸º 35 å¤©å‰
4. è§¦å‘é€šçŸ¥æ£€æŸ¥
5. æŸ¥çœ‹ç»´æŠ¤æé†’é€šçŸ¥
6. ç‚¹å‡»é€šçŸ¥è·³è½¬åˆ°è¢«å­è¯¦æƒ…
7. ç»“æŸä½¿ç”¨
8. æ ‡è®°é€šçŸ¥ä¸ºå·²è¯»

### åœºæ™¯ 2ï¼šé€šçŸ¥æ¸…ç†

1. åˆ›å»ºå¤šæ¡é€šçŸ¥
2. æ ‡è®°éƒ¨åˆ†ä¸ºå·²è¯»
3. ç­‰å¾… 30 å¤©ï¼ˆæˆ–æ‰‹åŠ¨ä¿®æ”¹ created_atï¼‰
4. è¿è¡Œæ¸…ç†ï¼š
   ```javascript
   fetch('/api/trpc/notifications.cleanup', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({ daysOld: 30 }),
   })
     .then(r => r.json())
     .then(console.log);
   ```
5. éªŒè¯æ—§çš„å·²è¯»é€šçŸ¥è¢«åˆ é™¤

## ğŸ“ æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŸºç¡€åŠŸèƒ½

- [ ] æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
- [ ] å¯ä»¥åˆ›å»ºé€šçŸ¥
- [ ] å¯ä»¥æŸ¥çœ‹é€šçŸ¥åˆ—è¡¨
- [ ] å¯ä»¥æ ‡è®°ä¸ºå·²è¯»
- [ ] å¯ä»¥åˆ é™¤é€šçŸ¥
- [ ] æœªè¯»è®¡æ•°æ­£ç¡®

### é€šçŸ¥è§„åˆ™

- [ ] ç»´æŠ¤æé†’ï¼ˆ30å¤©ï¼‰æ­£å¸¸è§¦å‘
- [ ] æ·˜æ±°å»ºè®®ï¼ˆ365å¤©ï¼‰æ­£å¸¸è§¦å‘
- [ ] ä¸ä¼šåˆ›å»ºé‡å¤é€šçŸ¥

### UI/UX

- [ ] é€šçŸ¥é¢æ¿æ­£å¸¸æ‰“å¼€/å…³é—­
- [ ] ä¼˜å…ˆçº§å¾½ç« æ˜¾ç¤ºæ­£ç¡®
- [ ] å›¾æ ‡æ˜¾ç¤ºæ­£ç¡®
- [ ] æ—¶é—´æ˜¾ç¤ºæ­£ç¡®
- [ ] ç‚¹å‡»è·³è½¬æ­£å¸¸
- [ ] åŠ è½½çŠ¶æ€æ˜¾ç¤º
- [ ] ç©ºçŠ¶æ€æ˜¾ç¤º

### æ€§èƒ½

- [ ] å¤§é‡é€šçŸ¥æ—¶æ€§èƒ½è‰¯å¥½
- [ ] è‡ªåŠ¨æ£€æŸ¥ä¸å½±å“ç”¨æˆ·ä½“éªŒ
- [ ] API å“åº”æ—¶é—´ < 1 ç§’

## ğŸš€ ç”Ÿäº§ç¯å¢ƒéªŒè¯

éƒ¨ç½²åˆ°ç”Ÿäº§åï¼š

1. è®¿é—®åº”ç”¨
2. æ‰“å¼€é€šçŸ¥é¢æ¿
3. éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
4. æ£€æŸ¥ Vercel æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯
5. ç›‘æ§æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
2. æŸ¥çœ‹ Vercel éƒ¨ç½²æ—¥å¿—
3. æŸ¥çœ‹ Neon æ•°æ®åº“æ—¥å¿—
4. æ£€æŸ¥æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†
