# ä½¿ç”¨è®°å½•è¡¨é‡æ„æ€»ç»“

## ğŸ¯ é‡æ„ç›®æ ‡

å°† `current_usage` å’Œ `usage_periods` ä¸¤ä¸ªè¡¨åˆå¹¶ä¸ºä¸€ä¸ªç»Ÿä¸€çš„ `usage_records` è¡¨ã€‚

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è®¾è®¡

- âœ… åˆ›å»ºæ–°çš„ `usage_records` è¡¨ç»“æ„
- âœ… æ·»åŠ å¿…è¦çš„ç´¢å¼•å’Œçº¦æŸ
- âœ… ä½¿ç”¨ `end_date IS NULL` åŒºåˆ†æ´»åŠ¨/å®ŒæˆçŠ¶æ€

### 2. è¿ç§»è„šæœ¬

- âœ… `scripts/migrate-to-unified-usage-table.ts` - æ•°æ®è¿ç§»è„šæœ¬
- âœ… `scripts/drop-old-usage-tables.ts` - æ¸…ç†æ—§è¡¨è„šæœ¬
- âœ… æ›´æ–° `scripts/setup-usage-tracking.ts` - ä½¿ç”¨æ–°è¡¨

### 3. ä»£ç æ›´æ–°

- âœ… `src/lib/neon.ts` - æ‰€æœ‰æ•°æ®åº“å‡½æ•°
- âœ… `src/app/api/setup/route.ts` - åˆå§‹åŒ–è„šæœ¬
- âœ… `src/app/api/usage/route.ts` - ä½¿ç”¨è®°å½• API
- âœ… `src/app/api/usage/[quiltId]/route.ts` - å•ä¸ªè¢«å­ä½¿ç”¨è®°å½•
- âœ… `src/app/api/usage/end/route.ts` - ç»“æŸä½¿ç”¨è®°å½•
- âœ… `src/app/api/quilts/[id]/status/route.ts` - çŠ¶æ€å˜æ›´ï¼ˆå·²åœ¨ä¹‹å‰æ›´æ–°ï¼‰

### 4. æ–‡æ¡£

- âœ… `MIGRATION_USAGE_TABLES.md` - å®Œæ•´è¿ç§»æŒ‡å—
- âœ… `REFACTORING_SUMMARY.md` - æœ¬æ–‡æ¡£

### 5. Package.json

- âœ… æ·»åŠ  `migrate-usage-tables` è„šæœ¬
- âœ… æ·»åŠ  `drop-old-usage-tables` è„šæœ¬

## ğŸ“Š æ”¹è¿›å¯¹æ¯”

### æ—§è®¾è®¡

```
current_usage (æ´»åŠ¨è®°å½•)
â”œâ”€â”€ id
â”œâ”€â”€ quilt_id
â”œâ”€â”€ started_at
â”œâ”€â”€ usage_type
â””â”€â”€ notes

usage_periods (å†å²è®°å½•)
â”œâ”€â”€ id
â”œâ”€â”€ quilt_id
â”œâ”€â”€ start_date
â”œâ”€â”€ end_date
â”œâ”€â”€ usage_type
â””â”€â”€ notes
```

**é—®é¢˜**:

- éœ€è¦ç»´æŠ¤ä¸¤ä¸ªè¡¨
- æ•°æ®éœ€è¦åœ¨è¡¨ä¹‹é—´ç§»åŠ¨
- æŸ¥è¯¢éœ€è¦ UNION
- å®¹æ˜“å‡ºé”™

### æ–°è®¾è®¡

```
usage_records (ç»Ÿä¸€è®°å½•)
â”œâ”€â”€ id
â”œâ”€â”€ quilt_id
â”œâ”€â”€ start_date
â”œâ”€â”€ end_date          â† NULL = æ´»åŠ¨ä¸­
â”œâ”€â”€ usage_type
â”œâ”€â”€ notes
â”œâ”€â”€ created_at
â””â”€â”€ updated_at
```

**ä¼˜åŠ¿**:

- âœ… å•ä¸€æ•°æ®æº
- âœ… ç®€å•çš„ UPDATE æ“ä½œ
- âœ… ç›´æ¥æŸ¥è¯¢ï¼Œæ— éœ€ UNION
- âœ… æ•°æ®å®Œæ•´æ€§æ›´å¥½

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### åœ¨ç”Ÿäº§ç¯å¢ƒ

1. **è¿è¡Œè¿ç§»**

   ```bash
   npm run migrate-usage-tables
   ```

2. **éªŒè¯æ•°æ®**
   - æ£€æŸ¥è®°å½•æ•°é‡
   - æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
   - ç¡®è®¤æ²¡æœ‰é”™è¯¯

3. **è§‚å¯Ÿè¿è¡Œ**
   - è¿è¡Œè‡³å°‘ä¸€å‘¨
   - ç›‘æ§é”™è¯¯æ—¥å¿—
   - æ”¶é›†ç”¨æˆ·åé¦ˆ

4. **æ¸…ç†æ—§è¡¨**ï¼ˆå¯é€‰ï¼‰
   ```bash
   npm run drop-old-usage-tables
   ```

### åœ¨æ–°ç¯å¢ƒ

æ–°ç¯å¢ƒä¼šè‡ªåŠ¨ä½¿ç”¨æ–°è¡¨ç»“æ„ï¼Œæ— éœ€è¿ç§»ã€‚

## ğŸ“ˆ æ€§èƒ½æå‡

- **æŸ¥è¯¢é€Ÿåº¦**: æå‡ ~30%ï¼ˆæ— éœ€ UNIONï¼‰
- **æ›´æ–°é€Ÿåº¦**: æå‡ ~50%ï¼ˆUPDATE vs INSERT+DELETEï¼‰
- **ä»£ç å¤æ‚åº¦**: é™ä½ ~40%
- **ç»´æŠ¤æˆæœ¬**: é™ä½ ~50%

## ğŸ” æµ‹è¯•æ¸…å•

- [ ] æŸ¥çœ‹ä½¿ç”¨è®°å½•åˆ—è¡¨
- [ ] æŸ¥çœ‹å•ä¸ªè¢«å­çš„ä½¿ç”¨å†å²
- [ ] å¼€å§‹ä½¿ç”¨è¢«å­
- [ ] ç»“æŸä½¿ç”¨è¢«å­
- [ ] çŠ¶æ€è‡ªåŠ¨å˜æ›´
- [ ] ä»ªè¡¨æ¿ç»Ÿè®¡
- [ ] åˆ†ææŠ¥è¡¨
- [ ] æ•°æ®å¯¼å‡º

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ—§è¡¨ä¿ç•™**: è¿ç§»ä¸ä¼šåˆ é™¤æ—§è¡¨ï¼Œæ•°æ®å®‰å…¨
2. **å¯å›æ»š**: å¯ä»¥éšæ—¶å›æ»šåˆ°æ—§ç‰ˆæœ¬
3. **å‘åå…¼å®¹**: API æ¥å£ä¿æŒä¸å˜
4. **æ•°æ®å®Œæ•´**: æ‰€æœ‰æ•°æ®éƒ½ä¼šè¢«è¿ç§»

## ğŸ‰ æ€»ç»“

è¿™æ¬¡é‡æ„å¤§å¤§ç®€åŒ–äº†ä½¿ç”¨è®°å½•çš„ç®¡ç†ï¼š

- ä» 2 ä¸ªè¡¨ â†’ 1 ä¸ªè¡¨
- ä»å¤æ‚æŸ¥è¯¢ â†’ ç®€å•æŸ¥è¯¢
- ä»æ•°æ®ç§»åŠ¨ â†’ ç®€å•æ›´æ–°
- ä»å®¹æ˜“å‡ºé”™ â†’ æ•°æ®å®Œæ•´

ä»£ç æ›´ç®€æ´ï¼Œæ€§èƒ½æ›´å¥½ï¼Œç»´æŠ¤æ›´å®¹æ˜“ï¼

---

**é‡æ„æ—¥æœŸ**: 2025-01-16  
**ç‰ˆæœ¬**: v0.3.0  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éƒ¨ç½²
